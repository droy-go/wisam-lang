# 🏗️ هندسة لغة وسام

> **شرح تفصيلي للبنية الداخلية ومكونات لغة وسام**

---

## 📐 نظرة عامة على البنية

```
┌─────────────────────────────────────────────────────────────────┐
│                        طبقة المستخدم                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │   CLI Tool  │  │   REPL      │  │   IDE Ext   │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      طبقة المترجم (Compiler)                    │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │   Lexer     │→│   Parser    │→│    AST      │             │
│  │  (محلل رموز)│  │(محلل نحوي) │  │ (شجرة نحو)  │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      طبقة التنفيذ (Runtime)                     │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │ Interpreter │  │    JIT      │  │   Memory    │             │
│  │  (المفسر)   │  │  (ترجمة    │  │   Manager   │             │
│  │             │  │   فورية)   │  │ (مدير الذاكرة)│            │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      طبقة المكتبات (Libraries)                  │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │
│  │  نصوص   │ │   زمن   │ │  مخزن   │ │  ذكاء   │ │  شبكة   │   │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘   │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐                           │
│  │  وسائط  │ │  واجهات │ │  ميتا   │                           │
│  └─────────┘ └─────────┘ └─────────┘                           │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔤 1. الليكسر (Lexer) - محلل الرموز

### الوظيفة
تحويل الكود النصي إلى قائمة من الرموز (Tokens) القابلة للمعالجة.

### المكونات

```c
// أنواع الرموز
typedef enum {
    TOKEN_LET,          // ليكن
    TOKEN_IF,           // إذا
    TOKEN_NUMBER,       // 123
    TOKEN_STRING,       // "نص"
    TOKEN_PLUS,         // +
    // ...
} TokenType;

// هيكل الرمز
typedef struct {
    TokenType type;     // نوع الرمز
    char value[256];    // القيمة النصية
    int line;           // رقم السطر
    int column;         // رقم العمود
} Token;
```

### سير العمل

```
الكود العربي:
    ليكن س = 10

الرموز المنتجة:
    ┌─────────┬────────┬──────┬────────┐
    │ النوع   │ القيمة │ السطر│ العمود │
    ├─────────┼────────┼──────┼────────┤
    │ LET     │ "ليكن" │  1   │   1    │
    │ IDENT   │ "س"    │  1   │   7    │
    │ ASSIGN  │ "="    │  1   │   9    │
    │ NUMBER  │ "10"   │  1   │   11   │
    └─────────┴────────┴──────┴────────┘
```

### دعم اللغة العربية

```c
// التحقق من الحروف العربية
bool is_arabic_char(unsigned char c) {
    // نطاق UTF-8 للعربية
    return (c >= 0xD8 && c <= 0xDB);
}

// كلمات مفتاحية عربية
static struct {
    const char *word;
    TokenType type;
} arabic_keywords[] = {
    {"ليكن", TOKEN_LET},
    {"إذا", TOKEN_IF},
    {"دالة", TOKEN_FUNCTION},
    // ...
};
```

---

## 🌳 2. البارسر (Parser) - محلل النحو

### الوظيفة
تحويل قائمة الرموز إلى شجرة نحوية مجردة (AST).

### أنواع العقد (Node Types)

```c
typedef enum {
    AST_PROGRAM,        // برنامج كامل
    AST_LET,            // تعريف متغير
    AST_IF,             // جملة شرطية
    AST_FOR,            // حلقة تكرار
    AST_FUNCTION_DEF,   // تعريف دالة
    AST_FUNCTION_CALL,  // استدعاء دالة
    AST_BINARY_OP,      // عملية ثنائية
    // ...
} ASTNodeType;
```

### مثال على AST

```wisam
# الكود:
إذا س > 5 إذن
    اكتب "كبير"
انتهى
```

```
الشجرة النحوية:

           ┌─────────┐
           │   IF    │
           └────┬────┘
                │
      ┌─────────┼─────────┐
      │         │         │
      ▼         ▼         ▼
┌─────────┐ ┌─────┐ ┌─────────┐
│  >      │ │THEN │ │  ELSE   │
└────┬────┘ │     │ │ (null)  │
     │      └─────┘ └─────────┘
  ┌──┴──┐
  │     │
  ▼     ▼
┌───┐ ┌───┐
│ س │ │ 5 │
└───┘ └───┘
```

### قواعد النحو (Grammar)

```ebnf
program     ::= statement*

statement   ::= let_stmt
              | const_stmt
              | if_stmt
              | for_stmt
              | func_def
              | func_call
              | import_stmt

let_stmt    ::= "ليكن" identifier "=" expression

if_stmt     ::= "إذا" expression "إذن" statement* 
                ("وإلا" statement*)? "انتهى"

for_stmt    ::= "لكل" identifier "من" expression 
                "إلى" expression statement* "انتهى"

func_def    ::= "دالة" identifier ("تأخذ" param_list)? 
                statement* "انتهى"

expression  ::= term (("+" | "-") term)*
term        ::= factor (("*" | "/") factor)*
factor      ::= number | string | identifier | 
                "(" expression ")"
```

---

## ⚙️ 3. المفسر (Interpreter)

### الوظيفة
تنفيذ شجرة AST وإنتاج النتائج.

### البيئة (Environment)

```c
typedef struct Environment {
    Variable variables[MAX_VARIABLES];
    int var_count;
    struct Environment *parent;  // للنطاقات المتداخلة
} Environment;
```

### أنواع القيم

```c
typedef enum {
    VAL_NUMBER,         // رقم (double)
    VAL_STRING,         // نص (char*)
    VAL_BOOLEAN,        // منطقي (bool)
    VAL_NULL,           // فارغ
    VAL_ARRAY,          // مصفوفة
    VAL_OBJECT,         // كائن
    VAL_FUNCTION,       // دالة
    VAL_MIND,           // عقل ذكاء
    VAL_NEURAL,         // شبكة عصبية
} ValueType;
```

### سير التنفيذ

```
┌────────────────────────────────────────┐
│           interpreter_run()            │
└─────────────────┬──────────────────────┘
                  │
    ┌─────────────┼─────────────┐
    │             │             │
    ▼             ▼             ▼
┌───────┐    ┌───────┐    ┌───────┐
│  LET  │    │  IF   │    │  FOR  │
└───┬───┘    └───┬───┘    └───┬───┘
    │            │            │
    ▼            ▼            ▼
┌───────┐    ┌───────┐    ┌───────┐
│eval() │    │eval() │    │eval() │
│expr   │    │cond   │    │range  │
└───────┘    └───────┘    └───────┘
```

---

## 📦 4. نظام المكتبات

### هيكل المكتبة

```c
typedef struct {
    const char *name;                    // اسم المكتبة
    Value (*functions[])(Value*, int);   // دوال المكتبة
    const char *function_names[];        // أسماء الدوال
    int function_count;                  // عدد الدوال
} Library;
```

### مثال: مكتبة النصوص

```c
Library lib_text = {
    .name = "نصوص",
    .functions = {
        lib_text_upper,      // حوّل_إلى_كبير
        lib_text_lower,      // حوّل_إلى_صغير
        lib_text_length,     // الطول
        lib_text_substring,  // جزء_من_نص
        lib_text_replace,    // استبدل
        lib_text_split,      // قسّم
        lib_text_trim,       // قص
        lib_text_translate,  // ترجم
    },
    .function_names = {
        "حوّل_إلى_كبير",
        "حوّل_إلى_صغير",
        "الطول",
        "جزء_من_نص",
        "استبدل",
        "قسّم",
        "قص",
        "ترجم",
    },
    .function_count = 8
};
```

---

## 🧠 5. نظام الذكاء الاصطناعي

### العقل (Mind)

```c
typedef struct {
    char *name;                    // اسم العقل
    MemoryPair memories[1000];     // الذكريات
    int memory_count;              // عدد الذكريات
    bool learning_enabled;         // التعلم مفعل؟
    
    // الدوال
    Value (*learn)(char*, char*);  // تعلم
    Value (*ask)(char*);           // سؤال
    Value (*save)(char*);          // حفظ
    Value (*load)(char*);          // تحميل
} Mind;
```

### الشبكة العصبية

```c
typedef struct {
    char *name;                    // اسم الشبكة
    int layers;                    // عدد الطبقات
    int *layer_sizes;              // أحجام الطبقات
    double learning_rate;          // معدل التعلم
    bool use_gpu;                  // استخدام GPU؟
    
    // الأوزان والانحيازات
    double ***weights;
    double **biases;
    
    // الدوال
    Value (*train)(char*);         // تدريب
    Value (*predict)(Value*);      // تنبؤ
    Value (*save)(char*);          // حفظ النموذج
} NeuralNetwork;
```

### المنظومة (System)

```c
typedef struct {
    char *name;                    // اسم المنظومة
    Mind *minds[10];               // العقول المكونة
    int mind_count;                // عدد العقول
    bool self_learning;            // التعلم الذاتي؟
    double confidence_threshold;   // عتبة الثقة
    
    // الدوال
    Value (*add_mind)(Mind*);      // إضافة عقل
    Value (*respond)(char*);       // الاستجابة
    Value (*self_learn)();         // التعلم الذاتي
} AISystem;
```

---

## 💾 6. إدارة الذاكرة

### استراتيجية التخصيص

```
┌─────────────────────────────────────────┐
│           كومة الذاكرة (Heap)           │
├─────────────────────────────────────────┤
│  ┌─────────┐  ┌─────────┐  ┌─────────┐ │
│  │ String  │  │  Array  │  │ Object  │ │
│  │ "نص"    │  │ [1,2,3] │  │ {...}   │ │
│  └─────────┘  └─────────┘  └─────────┘ │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │         Garbage Collector       │   │
│  │  (تجميع البيانات غير المستخدمة) │   │
│  └─────────────────────────────────┘   │
└─────────────────────────────────────────┘
```

### إدارة المراجع

```c
typedef struct {
    Value *value;
    int ref_count;      // عدد المراجع
    bool marked;        // محدد للـ GC؟
} GCObject;

// زيادة المرجع
void retain(GCObject *obj) {
    obj->ref_count++;
}

// إنقاص المرجع
void release(GCObject *obj) {
    obj->ref_count--;
    if (obj->ref_count == 0) {
        free_object(obj);
    }
}
```

---

## 🔄 7. نظام الوحدات (Modules)

### استيراد الوحدات

```wisam
# استيراد المكتبة كاملة
استورد نصوص

# استيراد دالة محددة
من نصوص استورد حوّل_إلى_كبير

# استيراد باسم مستعار
استورد نصوص باسم ن

# الاستخدام
ن.حوّل_إلى_كبير("مرحبا")
```

### هيكل الوحدة

```
مكتبة_نصوص/
├── __init__.wsm      # نقطة الدخول
├── upper.wsm         # دوال التحويل
├── lower.wsm
├── split.wsm
└── utils.wsm         # أدوات مساعدة
```

---

## 🎯 8. التحسينات المستقبلية

### JIT Compilation

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  AST        │────→│  LLVM IR    │────→│ Machine Code│
└─────────────┘     └─────────────┘     └─────────────┘
                           │
                           ▼
                    ┌─────────────┐
                    │  Optimizer  │
                    │  (تحسين)    │
                    └─────────────┘
```

### WebAssembly Backend

```
وسام الكود ──→ WASM ──→ تشغيل في المتصفح
```

### Parallel Execution

```
┌─────────────────────────────────────────┐
│           Thread Pool                   │
│  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐      │
│  │ T1  │ │ T2  │ │ T3  │ │ T4  │      │
│  └─────┘ └─────┘ └─────┘ └─────┘      │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │         Task Queue              │   │
│  │ [task1, task2, task3, ...]      │   │
│  └─────────────────────────────────┘   │
└─────────────────────────────────────────┘
```

---

## 📊 مقارنة الأداء

| العملية | وسام | Python | JavaScript |
|---------|------|--------|------------|
| حلقة 1M | 0.5s | 2.1s | 1.8s |
| استدعاء دالة | 0.1μs | 0.5μs | 0.3μs |
| تخصيص ذاكرة | 0.2μs | 0.8μs | 0.5μs |

---

## 🔗 روابط مفيدة

- [تصميم لغات البرمجة](https://en.wikipedia.org/wiki/Programming_language_design)
- [LLVM](https://llvm.org/)
- [WebAssembly](https://webassembly.org/)

---

<div align="center">

**📧 للتواصل:** [droy.ree@gmail.com](mailto:droy.ree@gmail.com)

</div>
